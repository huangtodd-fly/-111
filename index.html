<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½å­•ç®¡å®¶ - ç§‘å­¦å­•æœŸç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #FF85A1;
            --soft-pink: #FFF0F3;
            --text-dark: #4A4A4A;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FDFBFC;
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #FF85A1 0%, #FFB1C1 100%);
        }
        .card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(255, 133, 161, 0.1);
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .chat-bubble-user {
            background-color: var(--primary-pink);
            color: white;
            border-radius: 1rem 1rem 0 1rem;
        }
        .chat-bubble-ai {
            background-color: #F3F4F6;
            color: var(--text-dark);
            border-radius: 1rem 1rem 1rem 0;
        }
        /* æ­£åœ¨è¾“å…¥åŠ¨ç”» */
        .typing-dot {
            width: 4px;
            height: 4px;
            background: #999;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-4px); }
        }
    </style>
</head>
<body class="pb-24">

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="gradient-bg text-white p-6 rounded-b-[2.5rem] shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">ğŸ‘¶ å¥½å­•ç®¡å®¶ | AI å¢å¼ºç‰ˆ</h1>
            <button onclick="openSettings()" class="opacity-80"><i class="fas fa-cog text-xl"></i></button>
        </div>
        
        <div id="countdown-card" class="text-center py-4">
            <p class="text-sm opacity-90 mb-1" id="current-week-display">ç‚¹å‡»è®¾ç½®é¢„äº§æœŸ</p>
            <div class="text-5xl font-black mb-2" id="days-left-display">--</div>
            <p class="text-sm opacity-90">è·å®å®å‡ºç”Ÿè¿˜æœ‰å¤šå°‘å¤©</p>
        </div>

        <div class="mt-6">
            <div class="flex justify-between text-xs mb-1">
                <span>å­•æ—©æœŸ</span>
                <span>å­•ä¸­æœŸ</span>
                <span>å­•æ™šæœŸ</span>
            </div>
            <div class="w-full bg-white/30 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-white h-full" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="px-4 mt-6">
        
        <!-- AI åŠ©æ‰‹å¿«æ·æé†’ -->
        <div class="card p-5 mb-6 border-l-4 border-[#FF85A1] flex items-start space-x-3 cursor-pointer" onclick="showTab('ai')">
            <div class="bg-pink-100 p-2 rounded-full">ğŸ¤–</div>
            <div>
                <h2 class="font-bold text-sm text-[#FF85A1]">çœŸ AI åŠ©æ‰‹æœ¬å‘¨é‡ç‚¹</h2>
                <p id="ai-week-summary" class="text-gray-600 text-xs mt-1 leading-relaxed italic">
                    æ­£åœ¨åˆ†ææ‚¨çš„å­•æœŸé˜¶æ®µ...
                </p>
            </div>
        </div>

        <div id="tab-content" class="space-y-4">
            <!-- ç”± JS å¡«å…… -->
        </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center h-16 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-50">
        <button onclick="showTab('home')" id="btn-home" class="flex flex-col items-center space-y-1 text-pink-500">
            <i class="fas fa-home"></i><span class="text-[10px]">æ¦‚è§ˆ</span>
        </button>
        <button onclick="showTab('milestones')" id="btn-milestones" class="flex flex-col items-center space-y-1 text-gray-400">
            <i class="fas fa-list-ul"></i><span class="text-[10px]">æ¸…å•</span>
        </button>
        <button onclick="showTab('policy')" id="btn-policy" class="flex flex-col items-center space-y-1 text-gray-400">
            <i class="fas fa-gavel"></i><span class="text-[10px]">æ”¿ç­–</span>
        </button>
        <button onclick="showTab('ai')" id="btn-ai" class="flex flex-col items-center space-y-1 text-gray-400">
            <i class="fas fa-robot"></i><span class="text-[10px]">AIåŠ©æ‰‹</span>
        </button>
    </nav>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">å­•æœŸè®¾ç½®</h3>
            <p class="text-sm text-gray-500 mb-4">æœ€åä¸€æ¬¡æœˆç»(LMP)çš„ç¬¬ä¸€å¤©ï¼š</p>
            <input type="date" id="lmp-date" class="w-full border rounded-xl p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-pink-300">
            <button onclick="saveSettings()" class="w-full gradient-bg text-white py-3 rounded-xl font-bold">å¼€å§‹è¿½è¸ª</button>
            <button onclick="closeSettings()" class="w-full mt-2 py-3 text-gray-400 text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // --- Gemini API é…ç½® ---
        const apiKey = "AIzaSyAa6XCTnJQzxUOvZzghRVd50EueN3OI56Y"; // è¿è¡Œæ—¶è‡ªåŠ¨æ³¨å…¥
        const modelName = "gemini-2.5-flash-preview-09-2025";
        
        // --- æ•°æ®é…ç½® ---
        const milestones = [
            { week: 6, title: "ç¬¬ä¸€æ¬¡äº§æ£€", detail: "Bè¶…æ£€æŸ¥ç¡®è®¤å®«å†…æ€€å­•ï¼ŒæŸ¥çœ‹èƒå¿ƒèƒèŠ½ã€‚" },
            { week: 12, title: "æ­£å¼å»ºæ¡£ & NT", detail: "æˆéƒ½å»ºè®®åœ¨ç¤¾åŒºå«ç”Ÿä¸­å¿ƒæˆ–å®šç‚¹åŒ»é™¢é¢†ã€Šæ¯å­å¥åº·æ‰‹å†Œã€‹ã€‚" },
            { week: 16, title: "å”ç­›/æ— åˆ›", detail: "æ’æŸ¥æŸ“è‰²ä½“å¼‚å¸¸ã€‚" },
            { week: 24, title: "å¤§æ’ç•¸", detail: "ç³»ç»Ÿæ€§æ’æŸ¥èƒå„¿ç»“æ„ç•¸å½¢ã€‚" },
            { week: 32, title: "æ™šæœŸè¯„ä¼°", detail: "å…³æ³¨èƒä½åŠèƒç›˜åŠŸèƒ½ã€‚" }
        ];

        const chengduPolicies = [
            { time: "ç¡®è®¤æ€€å­•å", title: "ç”Ÿè‚²ç™»è®°", detail: "é€šè¿‡â€˜å¤©åºœå¸‚æ°‘äº‘â€™Appè¿›è¡Œã€‚åæœŸæŠ¥é”€åŸºç¡€ã€‚" },
            { time: "å­•12å‘¨å‰", title: "é¢†å–æ¯å­æ‰‹å†Œ", detail: "å‡­èº«ä»½è¯å»ç¤¾åŒºå«ç”ŸæœåŠ¡ä¸­å¿ƒé¢†å–ã€‚" },
            { time: "åˆ†å¨©å‰", title: "åŒ»ä¿å¤‡æ¡ˆ", detail: "åœ¨å®šç‚¹åŒ»ç–—æœºæ„æŒç¤¾ä¿å¡åˆ·å¡ç»“ç®—ã€‚" }
        ];

        let appData = JSON.parse(localStorage.getItem('prego_data')) || { lmp: null };
        let currentStatus = { week: 0, day: 0 };

        // --- æ ¸å¿ƒé€»è¾‘ ---
        async function callGemini(prompt, useSearch = true) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­•æœŸåŠ©æ‰‹ï¼Œåå«â€œå¥½å­•ç®¡å®¶â€ã€‚
            ä½ çš„æœåŠ¡å¯¹è±¡æ˜¯æˆéƒ½å¸‚çš„ä¸€å¯¹å¹´è½»å¤«å¦‡ã€‚
            ä½ çš„å›ç­”å¿…é¡»åŸºäºï¼šç§‘å­¦åŒ»å­¦å¸¸è¯†ã€æˆéƒ½å¸‚æœ€æ–°çš„ç”Ÿè‚²ä¿é™©æ”¿ç­–ã€æ¸©æŸ”ä½“è´´çš„è¯­æ°”ã€‚
            å½“å‰ç”¨æˆ·å¤„äºæ€€å­•ç¬¬ ${currentStatus.week} å‘¨ç¬¬ ${currentStatus.day} å¤©ã€‚
            å¦‚æœæ¶‰åŠæˆéƒ½å¸‚æ”¿ç­–æˆ–åŒ»ç–—æœºæ„ï¼Œè¯·å°½é‡æä¾›æœ¬åœ°åŒ–çš„å‡†ç¡®ä¿¡æ¯ã€‚`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            if (useSearch) {
                payload.tools = [{ "google_search": {} }];
            }

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹ç´¯äº†ï¼Œè¯·ç¨åå†è¯•ã€‚";
                } catch (e) {
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            return "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®ã€‚";
        }

        async function updateAIWeeklyTip() {
            if (!appData.lmp) return;
            const tipEl = document.getElementById('ai-week-summary');
            const prompt = `ç®€è¦æ¦‚æ‹¬å­•ç¬¬ ${currentStatus.week} å‘¨çš„ç”Ÿç†å˜åŒ–è¦ç‚¹å’Œä¸€é¡¹é’ˆå¯¹æˆéƒ½å¸‚å‡†çˆ¸çˆ¸çš„å»ºè®®ã€‚å­—æ•°æ§åˆ¶åœ¨50å­—å†…ã€‚`;
            const summary = await callGemini(prompt, false);
            tipEl.innerText = summary;
        }

        function init() {
            if (!appData.lmp) {
                openSettings();
            } else {
                updateDashboard();
                showTab('home');
                updateAIWeeklyTip();
            }
        }

        function updateDashboard() {
            const lmp = new Date(appData.lmp);
            const now = new Date();
            const diffDays = Math.ceil(Math.abs(now - lmp) / (1000 * 60 * 60 * 24));
            const edd = new Date(lmp.getTime() + 280 * 24 * 60 * 60 * 1000);
            const daysLeft = Math.ceil((edd - now) / (1000 * 60 * 60 * 24));
            
            currentStatus.week = Math.floor(diffDays / 7);
            currentStatus.day = diffDays % 7;

            document.getElementById('current-week-display').innerText = `å­• ${currentStatus.week} å‘¨ ${currentStatus.day} å¤©`;
            document.getElementById('days-left-display').innerText = daysLeft > 0 ? daysLeft : "0";
            document.getElementById('progress-bar').style.width = Math.min((diffDays / 280) * 100, 100) + '%';
        }

        function showTab(tab) {
            const content = document.getElementById('tab-content');
            const btns = ['home', 'milestones', 'policy', 'ai'];
            btns.forEach(b => {
                const el = document.getElementById('btn-' + b);
                el.classList.remove('text-pink-500');
                el.classList.add('text-gray-400');
            });
            document.getElementById('btn-' + tab).classList.add('text-pink-500');

            if (tab === 'home') {
                content.innerHTML = `
                    <div class="card p-5 mb-4">
                        <h3 class="font-bold mb-3 flex items-center"><i class="fas fa-heart text-pink-500 mr-2"></i> å®å¦ˆä»Šæ—¥æé†’</h3>
                        <ul class="space-y-3 text-sm text-gray-600">
                            <li>âœ¨ è®°å¾—æ¯å¤©æ—©é¤åæœç”¨å¶é…¸ã€‚</li>
                            <li>ğŸ’¤ ä¿è¯å……è¶³ç¡çœ ï¼Œç¼“è§£å­•æ—©æœŸç–²åŠ³ã€‚</li>
                        </ul>
                    </div>
                    <div class="card p-5 bg-blue-50">
                        <h3 class="font-bold mb-2 text-blue-700">æˆéƒ½å®æ—¶æ”¿ç­–åŠ©æ‰‹</h3>
                        <p class="text-xs text-blue-600 leading-relaxed">æ‚¨å¯ä»¥åˆ‡æ¢åˆ°â€œAIåŠ©æ‰‹â€é¡µè¯¢é—®ï¼šæˆéƒ½å¸‚æœ€æ–°çš„ç”Ÿè‚²ä¿é™©æŠ¥é”€æ¯”ä¾‹æ˜¯å¤šå°‘ï¼Ÿ</p>
                    </div>
                `;
            } else if (tab === 'milestones') {
                content.innerHTML = milestones.map(m => `
                    <div class="card p-4 flex space-x-4 mb-3">
                        <div class="bg-pink-100 text-pink-600 rounded-xl px-3 py-2 text-center min-w-[60px]">
                            <span class="text-lg font-bold block">${m.week}å‘¨</span>
                        </div>
                        <div>
                            <h4 class="font-bold">${m.title}</h4>
                            <p class="text-xs text-gray-500 mt-1">${m.detail}</p>
                        </div>
                    </div>
                `).join('');
            } else if (tab === 'policy') {
                content.innerHTML = chengduPolicies.map(p => `
                    <div class="card p-5 mb-3 border-t-4 border-blue-400">
                        <h4 class="font-bold text-gray-800">${p.title}</h4>
                        <p class="text-xs text-gray-600 leading-relaxed mt-2">${p.detail}</p>
                    </div>
                `).join('');
            } else if (tab === 'ai') {
                content.innerHTML = `
                    <div class="flex flex-col h-[55vh]">
                        <div class="flex-1 overflow-y-auto space-y-4 p-2" id="chat-box">
                            <div class="chat-bubble-ai p-3 text-sm max-w-[85%] shadow-sm">
                                ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„çœŸÂ·AIåŠ©æ‰‹ã€‚
                                <br><br>
                                æˆ‘å·²ç»è¿æ¥äº’è”ç½‘ï¼Œæ‚¨å¯ä»¥é—®æˆ‘ï¼š<br>
                                â€¢ "æˆéƒ½åè¥¿äºŒé™¢å»ºæ¡£éœ€è¦ä»€ä¹ˆæ¡ä»¶ï¼Ÿ"<br>
                                â€¢ "æˆéƒ½èŒå·¥åŒ»ä¿ç”ŸäºŒèƒèƒ½é¢†å¤šå°‘é’±ï¼Ÿ"<br>
                                â€¢ "å­•æ—©æœŸçªç„¶æƒ³åƒç«é”…ï¼Œæœ‰ä»€ä¹ˆæˆéƒ½æ¨èçš„å¥åº·ç‚¹æ³•ï¼Ÿ"
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <input id="chat-input" type="text" placeholder="å‘AIæé—®..." class="flex-1 border rounded-full px-4 text-sm focus:outline-none focus:ring-2 focus:ring-pink-300">
                            <button onclick="sendMessage()" class="gradient-bg text-white w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            if (!input.value) return;

            const userMsg = input.value;
            input.value = "";
            box.innerHTML += `<div class="flex justify-end"><div class="chat-bubble-user p-3 text-sm max-w-[85%] shadow-sm">${userMsg}</div></div>`;
            box.scrollTop = box.scrollHeight;

            // æ˜¾ç¤ºåŠ è½½ä¸­
            const loadingId = 'loading-' + Date.now();
            box.innerHTML += `<div class="chat-bubble-ai p-3 text-sm max-w-[85%] shadow-sm" id="${loadingId}">
                <div class="typing-dot"></div> <div class="typing-dot"></div> <div class="typing-dot"></div>
            </div>`;
            box.scrollTop = box.scrollHeight;

            const reply = await callGemini(userMsg);
            
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) {
                loadingEl.innerHTML = reply.replace(/\n/g, '<br>');
            }
            box.scrollTop = box.scrollHeight;
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            const date = document.getElementById('lmp-date').value;
            if (date) {
                appData.lmp = date;
                localStorage.setItem('prego_data', JSON.stringify(appData));
                updateDashboard();
                closeSettings();
                showTab('home');
                updateAIWeeklyTip();
            }
        }

        window.onload = init;
    </script>
</body>
</html>

