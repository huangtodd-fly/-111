<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥½å­•ç®¡å®¶ - æˆéƒ½ç§‘å­¦å­•æœŸåŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-pink: #FF85A1;
            --soft-pink: #FFF0F3;
            --text-dark: #4A4A4A;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #FDFBFC;
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #FF85A1 0%, #FFB1C1 100%);
        }
        .card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 15px rgba(255, 133, 161, 0.1);
        }
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .chat-bubble-user {
            background-color: var(--primary-pink);
            color: white;
            border-radius: 1rem 1rem 0 1rem;
        }
        .chat-bubble-ai {
            background-color: #F3F4F6;
            color: var(--text-dark);
            border-radius: 1rem 1rem 1rem 0;
            white-space: pre-line;
        }
        .typing-dot {
            width: 4px; height: 4px; background: #999; border-radius: 50%;
            display: inline-block; animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-4px); } }
    </style>
</head>
<body class="pb-24">

    <!-- çŠ¶æ€æ  -->
    <div class="gradient-bg text-white p-6 rounded-b-[2.5rem] shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold">ğŸ‘¶ å¥½å­•ç®¡å®¶ | æˆéƒ½ç‰ˆ</h1>
            <button onclick="openSettings()" class="opacity-80"><i class="fas fa-cog text-xl"></i></button>
        </div>
        
        <div class="text-center py-4">
            <p class="text-sm opacity-90 mb-1" id="current-week-display">ç‚¹å‡»è®¾ç½®</p>
            <div class="text-5xl font-black mb-2" id="days-left-display">--</div>
            <p class="text-sm opacity-90">è·å®å®å‡ºç”Ÿè¿˜æœ‰å¤šå°‘å¤©</p>
        </div>

        <div class="mt-6">
            <div class="w-full bg-white/30 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-white h-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <main class="px-4 mt-6">
        <!-- AI å¿«æ·å»ºè®® -->
        <div class="card p-5 mb-6 border-l-4 border-[#FF85A1] flex items-start space-x-3 cursor-pointer" onclick="showTab('ai')">
            <div class="bg-pink-100 p-2 rounded-full text-xl">ğŸ¤–</div>
            <div class="flex-1">
                <h2 class="font-bold text-sm text-[#FF85A1]">åƒé—® AI å­•æœŸå®æ—¶å»ºè®®</h2>
                <p id="ai-week-summary" class="text-gray-600 text-xs mt-1 leading-relaxed italic">
                    æ­£åœ¨è¿çº¿åƒé—®å¤§æ¨¡å‹è¿›è¡Œåˆ†æ...
                </p>
            </div>
        </div>

        <div id="tab-content" class="space-y-4"></div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 flex justify-around items-center h-16 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-50">
        <button onclick="showTab('home')" id="btn-home" class="flex flex-col items-center space-y-1 text-pink-500">
            <i class="fas fa-home"></i><span class="text-[10px]">æ¦‚è§ˆ</span>
        </button>
        <button onclick="showTab('milestones')" id="btn-milestones" class="flex flex-col items-center space-y-1 text-gray-400">
            <i class="fas fa-list-ul"></i><span class="text-[10px]">äº§æ£€</span>
        </button>
        <button onclick="showTab('policy')" id="btn-policy" class="flex flex-col items-center space-y-1 text-gray-400">
            <i class="fas fa-gavel"></i><span class="text-[10px]">æ”¿ç­–</span>
        </button>
        <button onclick="showTab('ai')" id="btn-ai" class="flex flex-col items-center space-y-1 text-gray-400">
            <i class="fas fa-robot"></i><span class="text-[10px]">AIåŠ©æ‰‹</span>
        </button>
    </nav>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">å­•æœŸé…ç½®</h3>
            <p class="text-sm text-gray-500 mb-2">1. è¾“å…¥æœ€åä¸€æ¬¡æœˆç»æ—¥æœŸï¼š</p>
            <input type="date" id="lmp-date" class="w-full border rounded-xl p-3 mb-4 focus:ring-2 focus:ring-pink-300">
            <p class="text-sm text-gray-500 mb-2">2. è¾“å…¥é€šä¹‰åƒé—® API Keyï¼š</p>
            <input type="password" id="api-key-input" placeholder="sk-..." class="w-full border rounded-xl p-3 mb-4 focus:ring-2 focus:ring-pink-300">
            <button onclick="saveSettings()" class="w-full gradient-bg text-white py-3 rounded-xl font-bold">ä¿å­˜å¹¶å¼€å§‹</button>
            <button onclick="closeSettings()" class="w-full mt-2 py-3 text-gray-400 text-sm">ç¨åè®¾ç½®</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        let appData = JSON.parse(localStorage.getItem('prego_qwen_v1')) || { lmp: null, apiKey: "" };
        let currentStatus = { week: 0, day: 0 };

        // --- é€šä¹‰åƒé—® API é€»è¾‘ ---
        async function callQwen(userPrompt) {
            if (!appData.apiKey) return "è¯·åœ¨è®¾ç½®ä¸­é…ç½®é€šä¹‰åƒé—® API Keyã€‚";

            const systemContent = `ä½ æ˜¯ä¸€ä¸ªåä¸ºâ€œå¥½å­•ç®¡å®¶â€çš„ä¸“ä¸šAIåŠ©æ‰‹ã€‚
            ä½ çš„ä»»åŠ¡æ˜¯ååŠ©èº«åœ¨æˆéƒ½å¸‚çš„å‡†çˆ¸çˆ¸ç…§é¡¾æ€€å­• ${currentStatus.week} å‘¨ ${currentStatus.day} å¤©çš„è€å©†ã€‚
            ä½ çš„å»ºè®®å¿…é¡»åŸºäºåŒ»å­¦å¸¸è¯†å’Œæˆéƒ½å¸‚æœ€æ–°çš„æ”¿ç­–ï¼ˆå¦‚ç”Ÿè‚²ç™»è®°ã€èŒå·¥ç¤¾ä¿æŠ¥é”€ï¼‰ã€‚
            è¯­æ°”è¦ä¸“ä¸šä¸”å……æ»¡äººæ–‡å…³æ€€ã€‚å›ç­”å°½é‡ç²¾ç‚¼ï¼Œé€‚åˆæ‰‹æœºç«¯é˜…è¯»ã€‚`;

            const apiUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appData.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "qwen-plus", // æˆ–è€…ä½¿ç”¨ qwen-max
                        messages: [
                            { role: "system", content: systemContent },
                            { role: "user", content: userPrompt }
                        ]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.choices[0].message.content;
            } catch (error) {
                console.error(error);
                return "AI å“åº”è¶…æ—¶ã€‚ç”±äºå›½å†…ç›´è¿ï¼Œé€šå¸¸æ˜¯ API Key æ— æ•ˆæˆ–é¢åº¦ä¸è¶³ã€‚è¯·æ£€æŸ¥è®¾ç½®ã€‚";
            }
        }

        async function updateAIWeeklyTip() {
            if (!appData.lmp || !appData.apiKey) {
                document.getElementById('ai-week-summary').innerText = "è¯·å…ˆé…ç½® API Key ä»¥å¯ç”¨æ™ºèƒ½åˆ†æã€‚";
                return;
            }
            const tip = await callQwen(`é’ˆå¯¹æ€€å­•ç¬¬ ${currentStatus.week} å‘¨ï¼Œç»™å‡†çˆ¸çˆ¸å†™ä¸€æ¡æˆéƒ½å¸‚æœ¬åœ°çš„ç”Ÿæ´»å»ºè®®ï¼ˆ50å­—å†…ï¼‰ã€‚`);
            document.getElementById('ai-week-summary').innerText = tip;
        }

        // --- UI ä¸æ•°æ® ---
        function init() {
            if (!appData.lmp || !appData.apiKey) {
                openSettings();
            } else {
                updateDashboard();
                showTab('home');
                updateAIWeeklyTip();
            }
        }

        function updateDashboard() {
            if (!appData.lmp) return;
            const lmp = new Date(appData.lmp);
            const now = new Date();
            const diffDays = Math.ceil(Math.abs(now - lmp) / (1000 * 60 * 60 * 24));
            const edd = new Date(lmp.getTime() + 280 * 24 * 60 * 60 * 1000);
            const daysLeft = Math.max(0, Math.ceil((edd - now) / (1000 * 60 * 60 * 24)));
            
            currentStatus.week = Math.floor(diffDays / 7);
            currentStatus.day = diffDays % 7;

            document.getElementById('current-week-display').innerText = `å­• ${currentStatus.week} å‘¨ ${currentStatus.day} å¤©`;
            document.getElementById('days-left-display').innerText = daysLeft;
            document.getElementById('progress-bar').style.width = Math.min((diffDays / 280) * 100, 100) + '%';
        }

        function showTab(tab) {
            const content = document.getElementById('tab-content');
            const btns = ['home', 'milestones', 'policy', 'ai'];
            btns.forEach(b => document.getElementById('btn-' + b).className = "flex flex-col items-center space-y-1 text-gray-400");
            document.getElementById('btn-' + tab).className = "flex flex-col items-center space-y-1 text-pink-500";

            if (tab === 'home') {
                content.innerHTML = `
                    <div class="card p-5 mb-4">
                        <h3 class="font-bold mb-3 flex items-center text-pink-600"><i class="fas fa-check-circle mr-2"></i> ä»Šæ—¥å¿…å¤‡</h3>
                        <p class="text-sm text-gray-600 leading-relaxed">â— è¡¥å¶é…¸ï¼ˆ0.4mg/å¤©ï¼‰<br>â— æˆéƒ½æ°”è±¡å°æé†’ï¼šæ˜¼å¤œæ¸©å·®å¤§ï¼Œå®å¦ˆæ³¨æ„ä¿æš–<br>â— æ™šé—´å»ºè®®ï¼šæ•£æ­¥15åˆ†é’Ÿï¼Œç¼“è§£å‹åŠ›</p>
                    </div>
                    <div class="card p-5 bg-pink-50">
                        <h4 class="font-bold text-sm text-pink-700">æˆéƒ½å»ºæ¡£æŒ‡å—ï¼ˆå­•æ—©æœŸç‰ˆï¼‰</h4>
                        <p class="text-[11px] text-pink-600 mt-1">éœ€æºå¸¦ï¼šèº«ä»½è¯ã€ç»“å©šè¯ã€‚æ¨èå»ç¤¾åŒºæœåŠ¡ä¸­å¿ƒå…ˆé¢†æ‰‹å†Œï¼Œå†é¢„çº¦åè¥¿äºŒé™¢æˆ–æˆéƒ½å¦‡å¹¼ã€‚èŒå·¥åŒ»ä¿å¯æŠ¥é”€å®šé¢äº§æ£€è´¹ã€‚</p>
                    </div>`;
            } else if (tab === 'milestones') {
                const ms = [
                    { w: "6-8", t: "Bè¶…å¿ƒææ£€æŸ¥", d: "ç¡®è®¤å®«å†…å­•ï¼ŒæŸ¥çœ‹èƒå¿ƒèƒèŠ½ã€‚" },
                    { w: "11-13", t: "NTç­›æŸ¥", d: "æˆéƒ½å¤§åŒ»é™¢éœ€æå‰è‡³å°‘4å‘¨é¢„çº¦ã€‚" },
                    { w: "15-18", t: "å”æ°ç­›æŸ¥", d: "èŒå·¥åŒ»ä¿å®šç‚¹åŒ»é™¢å¯ç›´æ¥æŠ¥é”€ã€‚" }
                ];
                content.innerHTML = ms.map(m => `
                    <div class="card p-4 flex mb-3">
                        <div class="bg-pink-100 text-pink-600 p-2 rounded-xl text-center min-w-[50px] mr-4">
                            <span class="text-lg font-bold">${m.w}</span><span class="text-[10px]">å‘¨</span>
                        </div>
                        <div><h4 class="font-bold text-sm">${m.t}</h4><p class="text-xs text-gray-400">${m.d}</p></div>
                    </div>`).join('');
            } else if (tab === 'policy') {
                content.innerHTML = `
                    <div class="card p-5 mb-3 border-l-4 border-blue-400">
                        <h4 class="font-bold text-sm">æˆéƒ½ç”Ÿè‚²ç™»è®°</h4>
                        <p class="text-xs text-gray-500 mt-1">æœç´¢å¾®ä¿¡å°ç¨‹åºâ€œå››å·æ”¿åŠ¡æœåŠ¡â€ï¼ŒåŠç†â€œç”Ÿè‚²ç™»è®°è¯â€ã€‚è¿™æ˜¯åŠå‡†ç”Ÿè¯å’Œé¢†æ´¥è´´çš„ç¬¬ä¸€æ­¥ã€‚</p>
                    </div>
                    <div class="card p-5 border-l-4 border-green-400">
                        <h4 class="font-bold text-sm">èŒå·¥ç”Ÿè‚²ä¿é™©</h4>
                        <p class="text-xs text-gray-500 mt-1">åœ¨æˆéƒ½è¿ç»­ç¼´æ»¡6ä¸ªæœˆèŒå·¥åŒ»ä¿ï¼Œäº§å‡æœŸé—´å¯é¢†å·¥èµ„å…¨é¢æ´¥è´´ã€‚ä½é™¢æŠ¥é”€æ¯”ä¾‹æœ€é«˜å¯è¾¾90%ä»¥ä¸Šã€‚</p>
                    </div>`;
            } else if (tab === 'ai') {
                content.innerHTML = `
                    <div class="flex flex-col h-[50vh]">
                        <div class="flex-1 overflow-y-auto space-y-4 p-2" id="chat-box">
                            <div class="chat-bubble-ai p-3 text-sm max-w-[90%] shadow-sm">
                                æ¬¢è¿ä½¿ç”¨åƒé—®å¢å¼ºç‰ˆï¼æ‚¨å¯ä»¥é—®æˆ‘ï¼š<br>
                                â€¢ "æˆéƒ½åè¥¿äºŒé™¢æ€ä¹ˆæŠ¢å·ï¼Ÿ"<br>
                                â€¢ "å­•åˆæœŸçªç„¶è§çº¢æ€ä¹ˆåŠï¼Ÿ"<br>
                                â€¢ "æˆéƒ½å“ªå®¶ç«é”…åº—é€‚åˆå­•å¦‡åƒï¼Ÿ"
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <input id="chat-input" type="text" placeholder="å‘åƒé—®æé—®..." class="flex-1 border rounded-full px-4 text-sm focus:outline-none focus:ring-2 focus:ring-pink-300 h-10">
                            <button onclick="sendMessage()" class="gradient-bg text-white w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>`;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            if (!input.value) return;

            const userMsg = input.value;
            input.value = "";
            box.innerHTML += `<div class="flex justify-end"><div class="chat-bubble-user p-3 text-sm max-w-[85%]">${userMsg}</div></div>`;
            box.scrollTop = box.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            box.innerHTML += `<div class="chat-bubble-ai p-3 text-sm max-w-[85%]" id="${loadingId}"><div class="typing-dot"></div> <div class="typing-dot"></div> <div class="typing-dot"></div></div>`;
            box.scrollTop = box.scrollHeight;

            const reply = await callQwen(userMsg);
            document.getElementById(loadingId).innerText = reply;
            box.scrollTop = box.scrollHeight;
        }

        function openSettings() {
            document.getElementById('lmp-date').value = appData.lmp || "";
            document.getElementById('api-key-input').value = appData.apiKey || "";
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            const date = document.getElementById('lmp-date').value;
            const key = document.getElementById('api-key-input').value;
            if (date && key) {
                appData = { lmp: date, apiKey: key };
                localStorage.setItem('prego_qwen_v1', JSON.stringify(appData));
                updateDashboard();
                closeSettings();
                showTab('home');
                updateAIWeeklyTip();
            } else {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ä»¥å¯ç”¨åŠŸèƒ½");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
